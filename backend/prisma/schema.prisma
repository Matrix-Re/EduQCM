datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

//
// ───────────────────────────────
//   USER
// ───────────────────────────────
//
model User {
  id        Int      @id @default(autoincrement())
  lastname  String
  firstname String
  username  String   @unique
  password  String
  refresh_token String?
  refresh_token_expires_at DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  student   Student?
  teacher   Teacher?

  @@map("user")
}

//
// ───────────────────────────────
//   STUDENT (1–1 avec User)
// ───────────────────────────────
//
model Student {
  id                Int    @id
  completed_qcm_count Int?
  average_qcm_score Float?

  user User @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  results   Result[]

  @@map("student")
}

//
// ───────────────────────────────
//   TEACHER (1–1 avec User)
// ───────────────────────────────
//
model Teacher {
  id               Int @id
  created_qcm_count Int?

  user User @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  qcms Qcm[]

  @@map("teacher")
}

//
// ───────────────────────────────
//   TOPIC
// ───────────────────────────────
//
model Topic {
  id    Int    @id @default(autoincrement())
  label String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  qcms Qcm[]

  @@map("topic")
}

//
// ───────────────────────────────
//   QCM (belongs to Teacher + Topic)
// ───────────────────────────────
//
model Qcm {
  id        Int    @id @default(autoincrement())
  label     String?
  author_id Int
  topic_id  Int
  time_limit Int?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  author Teacher @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  topic  Topic   @relation(fields: [topic_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  questions Question[]
  results   Result[]

  @@map("qcm")
}

//
// ───────────────────────────────
//   RESULT (belongs to User + QCM)
// ───────────────────────────────
//
model Result {
  id              Int      @id @default(autoincrement())
  assignment_date DateTime
  completion_date DateTime?
  score           Float?
  qcm_id          Int
  student_id         Int

  student Student @relation(fields: [student_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  qcm  Qcm  @relation(fields: [qcm_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  answers Answer[]

  @@map("result")
}

//
// ───────────────────────────────
//   QUESTION (belongs to QCM)
// ───────────────────────────────
//
model Question {
  id     Int    @id @default(autoincrement())
  label  String?
  qcm_id Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  qcm       Qcm       @relation(fields: [qcm_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  proposals Proposal[]

  @@map("question")
}

//
// ───────────────────────────────
//   PROPOSAL (belongs to Question)
// ───────────────────────────────
//
model Proposal {
  id          Int     @id @default(autoincrement())
  label       String?
  is_correct  Boolean?
  question_id Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  question Question @relation(fields: [question_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  answers  Answer[]

  @@map("proposal")
}

//
// ───────────────────────────────
//   ANSWER (composite primary key)
// ───────────────────────────────
//
model Answer {
  result_id     Int
  proposal_id   Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  result   Result   @relation(fields: [result_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  proposal Proposal @relation(fields: [proposal_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([result_id, proposal_id])
  @@map("answer")
}
